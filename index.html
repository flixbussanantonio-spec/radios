<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Radios de Chile y M√∫sica Libre</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; font-size:12px; text-align:center; background:#fff; margin:6px 0; }
  h1, h2 { font-size:14px; margin:6px 0; }
  audio { width:92%; margin:8px auto; display:block; }
  select, button, a { font-size:12px; padding:4px 6px; margin:6px 2px; }
  #status { font-size:11px; color:#444; min-height:16px; margin-top:6px; }
  .row { display:flex; justify-content:center; gap:6px; flex-wrap:wrap; }
  .muted { color:#b00020; }
  .tiny { font-size:10px; opacity:.75 }
</style>
</head>
<body>

<h1>üéß Radios de Chile y M√∫sica Libre</h1>

<audio id="player" controls preload="none"></audio>

<div class="row">
  <button id="startBtn" type="button">Iniciar</button>
</div>

<h2>Selecciona tu emisora</h2>
<select id="radios">
  <!-- FUNCIONALES CHILENAS -->
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/ADN_SC.mp3">ADN (Noticias y Pop Rock)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/ROCKANDPOP_SC.mp3">Rock & Pop (Rock/Pop)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/CONCIERTO_SC.mp3">Radio Concierto (Pop/Soft Rock)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/IMAGINA_SC.mp3">Radio Imagina (Rom√°ntica)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/BEETHOVEN_SC.mp3">Radio Beethoven (Cl√°sica)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/FUTURO_SC.mp3">Radio Futuro (Rock Cl√°sico)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/RADIOCORAZON_SC.mp3">Radio Coraz√≥n (Latina/Bailable)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/CAROLINA_SC.mp3">Radio Carolina (Urbana/Reggaet√≥n)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/OASIS_SC.mp3">Radio Oasis (Pop Retro)</option>
  <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/UNIVERSO_SC.mp3">Radio Universo (Pop Lounge)</option>

  <!-- M√öSICA INTERNACIONAL / LIBRE -->
  <option value="https://ice2.somafm.com/groovesalad-128-mp3">SomaFM Groove Salad (Chill)</option>
  <option value="https://ice2.somafm.com/beatblender-128-mp3">SomaFM Beat Blender (Lo-fi)</option>
  <option value="https://ice2.somafm.com/jazz24-128-mp3">Jazz24 (Jazz Cl√°sico/Contemp.)</option>
  <option value="https://ice2.somafm.com/missioncontrol-128-mp3">Mission Control (Ambient/Espacial)</option>
  <option value="https://ice2.somafm.com/u80s-128-mp3">SomaFM Underground 80s (Retro)</option>
  <option value="https://ice2.somafm.com/dronezone-128-mp3">SomaFM Drone Zone (Relax/Ambient)</option>
  <option value="https://ice2.somafm.com/thetrip-128-mp3">SomaFM The Trip (Electr√≥nica)</option>
  <option value="https://ice2.somafm.com/lush-128-mp3">SomaFM Lush (Vocal Lounge)</option>
  <option value="https://streaming.radionomy.com/JazzRadio">JazzRadio (Instrumental)</option>
</select>

<div class="row">
  <button id="retryBtn" type="button" disabled>Reintentar</button>
  <button id="nextBtn" type="button" disabled>Siguiente ‚ñ∂</button>
  <a id="openLink" href="#" target="_blank" rel="noopener">Abrir stream</a>
</div>

<div id="status"></div>
<div class="tiny">Si no suena dentro de Wix, usa ‚ÄúAbrir stream‚Äù.</div>

<script>
(function(){
  const player   = document.getElementById('player');
  const radios   = document.getElementById('radios');
  const startBtn = document.getElementById('startBtn');
  const retryBtn = document.getElementById('retryBtn');
  const nextBtn  = document.getElementById('nextBtn');
  const statusEl = document.getElementById('status');
  const openLink = document.getElementById('openLink');

  let started = false;
  let autoTries = 0;
  const MAX_AUTO_TRIES = 2;
  const MAX_FALLBACKS  = 5;
  let fallbackCount = 0;

  function setStatus(msg, isError=false){
    statusEl.textContent = msg || '';
    statusEl.className = isError ? 'muted' : '';
  }

  function canPlay(url){
    const ext = url.split('?')[0].split('.').pop().toLowerCase();
    if (ext === 'mp3') return !!player.canPlayType && player.canPlayType('audio/mpeg');
    const mp3Ok = !!player.canPlayType && player.canPlayType('audio/mpeg');
    const aacOk = !!player.canPlayType && (player.canPlayType('audio/aac') || player.canPlayType('audio/mp4'));
    return mp3Ok || aacOk;
  }

  function explainError() {
    const err = player.error;
    if (!err) return '';
    const map = {1:'Abortado',2:'Red/CORS',3:'Decodificaci√≥n',4:'No soportada/bloqueada'};
    return ` C√≥digo ${err.code}: ${map[err.code]}`;
  }

  function currentIndex(){ return radios.selectedIndex >= 0 ? radios.selectedIndex : 0; }
  function nextIndex(){ return (currentIndex() + 1) % radios.options.length; }

  async function playUrl(url){
    try {
      if (!canPlay(url)) throw new Error('Formato no soportado por este navegador.');
      player.pause();
      player.src = url;
      player.load();
      const p = player.play();
      if (p && typeof p.then === 'function') await p;
      setStatus('Reproduciendo ‚úÖ');
      retryBtn.disabled = false;
      nextBtn.disabled = false;
      autoTries = 0; fallbackCount = 0;
      openLink.href = url;
      return true;
    } catch (e) {
      return false;
    }
  }

  function handleFailure(){
    const note = explainError();
    if (autoTries < MAX_AUTO_TRIES) {
      autoTries++;
      setStatus(`Reintentando (${autoTries}/${MAX_AUTO_TRIES})‚Ä¶${note}`);
      playUrl(radios.value).then(ok => { if(!ok) handleFailure(); });
      return;
    }
    if (fallbackCount < MAX_FALLBACKS) {
      fallbackCount++;
      autoTries = 0;
      radios.selectedIndex = nextIndex();
      setStatus(`Probando siguiente emisora‚Ä¶${note}`);
      playUrl(radios.value).then(ok => { if(!ok) handleFailure(); });
      return;
    }
    setStatus(`No se pudo reproducir aqu√≠. Usa ‚ÄúAbrir stream‚Äù.${note}`, true);
  }

  async function cambiarRadio(){
    if (!started) return;
    setStatus('Cargando emisora‚Ä¶');
    const ok = await playUrl(radios.value);
    if (!ok) handleFailure();
  }

  startBtn.addEventListener('click', async ()=>{
    started = true;
    setStatus('Iniciando‚Ä¶');
    await cambiarRadio();
  });

  radios.addEventListener('change', cambiarRadio);
  retryBtn.addEventListener('click', cambiarRadio);
  nextBtn.addEventListener('click', ()=>{
    radios.selectedIndex = nextIndex();
    cambiarRadio();
  });

  ['error','stalled','abort','emptied'].forEach(ev=>{
    player.addEventListener(ev, ()=> { if(started) handleFailure(); });
  });

  openLink.href = radios.value;
})();
</script>

</body>
</html>
